<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>User Profile | Shelf Life</title>

        <link rel="stylesheet" href="/style.css" />

        <link
            href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap"
            rel="stylesheet"
        />

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

    </head>

    <body>
        <%- include("partials/header") %>
        <br>

        <h1><%= user.username %>'s Profile</h1>
        <hr />
        <br><br>

        <h2>My Reviews</h2>
        <% if (reviews.length > 0) { %>
            <% reviews.forEach(review => { %>
                <div class="review-card">
                    <div>
                        <% if (review.bookInfo && review.bookInfo.thumbnail) { %>
                            <img src="<%= review.bookInfo.thumbnail %>" alt="Book cover" />
                        <% } %>
                    </div>
                    <div>
                        <h3><%= review.title %></h3>

                        <% if (review.bookInfo && review.bookInfo.authors) { %>
                            <h4><%=review.bookInfo.authors.join(", ")%></h4>
                        <% } %>

                        <p><strong>Rating:</strong> <%= review.rating %> / 5</p>

                        <% if (review.containsSpoiler) { %>
                            <p class="spoiler-warning">⚠️ Contains Spoilers</p>
                        <% } %>

                        <p>"<%= review.reviewText %>"</p>

                        <div class="review-actions">
                            <button type="button" class="btn-edit" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#reviewModal"
                                    data-review-id="<%= review.reviewId %>"
                                    data-review-text="<%= review.reviewText %>"
                                    data-rating="<%= review.rating %>"
                                    data-spoiler="<%= review.containsSpoiler %>"
                                    data-title="<%= review.title %>">
                                Edit
                            </button>

                            <form action="/review/delete" style="display:inline;">
                                <input type="hidden" name="reviewId" value="<%= review.reviewId %>">
                                <button type="submit" class="btn-delete">Delete</button>
                            </form>                       
                        </div>
                    </div>
                    
                </div>
                <br><hr style="width: 100%;"><br>
            <% }); %>
        <% } else { %>
            <p>You haven't written any reviews yet!</p>
        <% } %>


        <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="reviewModalLabel">Edit Review</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form action="/review/edit" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="reviewId" id="modal_reviewId">
                            
                            <div class="mb-3">
                                <label for="updatedRating" class="form-label">Rating (1-5):</label>
                                <input type="number" class="form-control" min="1" max="5" name="updatedRating" id="updatedRating" required>
                            </div>

                            <div class="mb-3">
                                <label for="updatedReview" class="form-label">Review:</label>
                                <textarea name="updatedReview" id="updatedReview" rows="5" class="form-control" required></textarea>
                            </div>
                            
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="isSpoiler" id="updatedSpoiler">
                                <label class="form-check-label" for="updatedSpoiler">This review contains spoilers</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Review</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <%- include("partials/footer") %>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const reviewModal = document.getElementById('reviewModal');

                // This event listener fires whenever the modal is about to be shown
                reviewModal.addEventListener('show.bs.modal', function (event) {
                    // Get the button that triggered the modal
                    const button = event.relatedTarget; 

                    // Extract data from the data-* attributes on the button
                    const reviewId = button.getAttribute('data-review-id');
                    const reviewText = button.getAttribute('data-review-text');
                    const rating = button.getAttribute('data-rating');
                    const title = button.getAttribute('data-title');
                    // spoiler is '1' (true) or '0' (false) from the database
                    const containsSpoiler = button.getAttribute('data-spoiler') === '1';

                    // Get the elements inside the modal
                    const modalTitle = reviewModal.querySelector('.modal-title');
                    const modalReviewIdInput = reviewModal.querySelector('#modal_reviewId');
                    const modalRatingInput = reviewModal.querySelector('#updatedRating');
                    const modalReviewInput = reviewModal.querySelector('#updatedReview');
                    const modalSpoilerCheckbox = reviewModal.querySelector('#updatedSpoiler');
                    
                    // Update the modal's content with the review's data
                    modalTitle.textContent = 'Editing review for: ' + title;
                    modalReviewIdInput.value = reviewId;
                    modalRatingInput.value = rating;
                    modalReviewInput.value = reviewText;
                    modalSpoilerCheckbox.checked = containsSpoiler;
                });
            });
        </script>
    </body>
</html>