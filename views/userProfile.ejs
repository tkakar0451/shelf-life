<%- include("partials/header") %>
<div class="container py-4">   <!-- NEW -->

  <h1 class="page-title mb-3"><%= user.username %>'s Profile</h1>
  <hr class="mb-4">

  <h2 class="mb-3">My Reviews</h2>
  <% if (reviews.length > 0) { %>
    <% reviews.forEach(review => { %>

      <article class="card review-card shadow-sm mb-4">   <!-- changed wrapper -->
        <div class="card-body d-flex gap-3 align-items-start">
          <% if (review.bookInfo && review.bookInfo.thumbnail) { %>
            <img class="book-thumb"
                 src="<%= review.bookInfo.thumbnail %>"
                 alt="Book cover" />
          <% } %>

          <div class="flex-grow-1">
            <h3 class="h5 mb-1"><%= review.title %></h3>

            <% if (review.bookInfo && review.bookInfo.authors) { %>
              <div class="text-muted small mb-2"><%= review.bookInfo.authors.join(", ") %></div>
            <% } %>

            <!-- kept numeric rating to avoid backend changes -->
            <div class="mb-2"><strong>Rating:</strong> <%= review.rating %> / 5</div>

            <% if (review.containsSpoiler) { %>
              <span class="badge bg-warning text-dark mb-2">Spoiler</span>
            <% } %>

            <p class="mb-3">"<%= review.reviewText %>"</p>

            <div class="d-flex gap-2">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="modal" 
                      data-bs-target="#reviewModal"
                      data-review-id="<%= review.reviewId %>"
                      data-review-text="<%= review.reviewText %>"
                      data-rating="<%= review.rating %>"
                      data-spoiler="<%= review.containsSpoiler %>"
                      data-title="<%= review.title %>">
                Edit
              </button>

              <form action="/review/delete" class="m-0">
                <input type="hidden" name="reviewId" value="<%= review.reviewId %>">
                <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </article>

    <% }); %>
  <% } else { %>
    <div class="empty-state text-center py-5">
      <p class="mb-3">You haven’t written any reviews yet!</p>
      <a href="/" class="btn btn-primary">Find a Book</a>
    </div>
  <% } %>

  <!-- Edit Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="reviewModalLabel">Edit review</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- IMPORTANT: names match server expectations -->
      <form action="/review/edit" method="POST">
        <div class="modal-body">
          <input type="hidden" name="reviewId" id="modal_reviewId">

          <div class="mb-3">
            <label for="updatedRating" class="form-label">Rating (1–5)</label>
            <input type="number" min="1" max="5" class="form-control" name="updatedRating" id="updatedRating" required>
          </div>

          <div class="mb-3">
            <label for="updatedReview" class="form-label">Review</label>
            <textarea class="form-control" rows="5" name="updatedReview" id="updatedReview" required></textarea>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isSpoiler" id="updatedSpoiler">
            <label class="form-check-label" for="updatedSpoiler">Contains spoilers</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Review</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/userProfile.js"> </script>

</div>   <!-- /container -->
<%- include("partials/footer") %>