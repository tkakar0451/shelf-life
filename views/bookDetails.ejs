<!-- views/bookDetails.ejs -->

<%- include('partials/header') %>

<div class="container mt-4">

  <div class="row g-4">
    <!-- Cover -->
    <div class="col-md-4">
      <img
        src="<%= (book.imageLinks && (book.imageLinks.medium || book.imageLinks.large || book.imageLinks.thumbnail)) || '/images/default-book.png' %>"
        alt="Book cover for <%= book.title %>"
        class="img-fluid shadow rounded"
      />
    </div>

    <!-- Book info -->
    <div class="col-md-8">
      <h2 id="book-title"><%= book.title %></h2>
      <h5 class="text-muted">
        By
        <%= Array.isArray(book.authors) ? book.authors.join(', ') : (book.authors || 'Unknown Author') %>
      </h5>

      <p><%- book.description ? book.description : "No description available." %></p>

      <% if (logIn) { %>
        <button
          class="btn btn-primary mt-3"
          id="addNewReview"
          data-bs-toggle="modal"
          data-bs-target="#addReviewModal"
          data-book-id="<%= (typeof bookId !== 'undefined' && bookId) ? bookId : (book.id || '') %>"
          data-title="<%= book.title %>"
          data-thumb="<%= (book.imageLinks && (book.imageLinks.medium || book.imageLinks.large || book.imageLinks.thumbnail)) || '' %>"
        >
          Add Review
        </button>
      <% } else { %>
        <button
          class="btn btn-outline-secondary mt-3"
          data-bs-toggle="modal"
          data-bs-target="#loginPromptModal"
        >
          Add Review (Login Required)
        </button>
      <% } %>
    </div><!-- /col-md-8 -->
  </div><!-- /row -->

  <!-- User reviews -->
  <div class="reviews-section mt-5">
    <h4 class="reviews-title">User Reviews</h4>

    <% if (!Array.isArray(reviews) || reviews.length === 0) { %>
      <p class="text-muted">No reviews yet. Be the first to leave one!</p>
    <% } else { %>
      <div class="reviews-grid">
        <% reviews.forEach(review => { %>
          <div class="testimonial-card">
            <div class="testimonial-header">
              <% if (review.bookInfo?.thumbnail) { %>
                <img src="<%= review.bookInfo.thumbnail %>" alt="<%= review.username %>" class="testimonial-avatar">
              <% } else { %>
                <div class="testimonial-avatar placeholder"></div>
              <% } %>
              <div>
                <h5 class="testimonial-name"><%= review.username %></h5>
                <div class="testimonial-stars"><%= generateStarRating(review.rating) %></div>
              </div>
            </div>
            <p class="testimonial-text"><%= review.reviewText %></p>
            <% if (review.containsSpoiler) { %>
              <span class="spoiler-badge">Contains Spoilers</span>
            <% } %>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div><!-- /reviews-section -->

</div><!-- /container -->

<!-- Add Review Modal -->
<%- include('partials/addReview') %>

<!-- Login required modal -->
<div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginPromptModalLabel">Login Required</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You must be logged in to add a review.
      </div>
      <div class="modal-footer">
        <a href="/login?redirectUrl=/books/<%= bookId %>" class="btn btn-primary">Login</a>
        <a href="/signup?redirectUrl=/books/<%= bookId %>" class="btn btn-secondary">Sign Up</a>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/addReview.js"></script>

<%- include('partials/footer') %>