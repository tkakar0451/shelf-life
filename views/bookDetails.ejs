<!-- 
  File: views/book-details.ejs
  Author: Yusra Ashar
  Description: Displays detailed info for a selected book, existing reviews,
               and an Add Review modal trigger with login-aware UI.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= book.title %> - Shelf Life</title>

  <!-- CSS & Bootstrap -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>

<body>
  <!-- Simple navbar (uses logIn from res.locals) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Shelf Life</a>

      <div class="d-flex">
        <% if (logIn) { %>
          <a class="nav-link text-white" href="/profile">My Profile</a>
          <a class="nav-link text-white" href="/logout">Logout</a>
        <% } else { %>
          <a class="nav-link text-white" href="/login">Login</a>
          <a class="nav-link text-white" href="/signup">Signup</a>
        <% } %>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row g-4">
      <!-- Book cover -->
      <div class="col-md-4">
        <img
          src="<%= (book.imageLinks && (book.imageLinks.medium || book.imageLinks.large || book.imageLinks.thumbnail)) || '/images/default-book.png' %>"
          alt="Book cover for <%= book.title %>"
          class="img-fluid shadow rounded"
        />
      </div>

      <!-- Book info -->
      <div class="col-md-8">
        <h2 id="book-title"><%= book.title %></h2>
        <h5 class="text-muted">
          By
          <%= Array.isArray(book.authors) ? book.authors.join(', ') : (book.authors || 'Unknown Author') %>
        </h5>

        <p>
          <%- book.description ? book.description : "No description available." %>
        </p>

        <!-- Add Review button -->
        <% if (logIn) { %>
          <button
            class="btn btn-primary mt-3"
            id="addNewReview"
            data-bs-toggle="modal"
            data-bs-target="#addReviewModal"
            data-book-id="<%= (typeof bookId !== 'undefined' && bookId) ? bookId : (book.id || '') %>"
            data-title="<%= book.title %>"
            data-thumb="<%= (book.imageLinks && (book.imageLinks.medium || book.imageLinks.large || book.imageLinks.thumbnail)) || '' %>"
          >
            Add Review
          </button>
        <% } else { %>
          <button
            class="btn btn-outline-secondary mt-3"
            data-bs-toggle="modal"
            data-bs-target="#loginPromptModal"
          >
            Add Review (Login Required)
          </button>
        <% } %>
      </div>
    </div>

    <!-- User reviews -->
    <div class="mt-5">
      <h4>User Reviews</h4>

      <% if (!Array.isArray(reviews) || reviews.length === 0) { %>
        <p class="text-muted">No reviews yet. Be the first to leave one!</p>
      <% } else { %>
        <% reviews.forEach(review => { %>
          <div class="card mb-3">
            <div class="card-body">
              <p class="mb-1">
                <strong><%= review.username %></strong>
                rated it
                <%= review.rating %>/5
              </p>

              <% if (review.containsSpoilers) { %>
                <span class="badge bg-warning text-dark">Spoiler</span>
              <% } %>

              <p class="mt-2 mb-0"><%= review.reviewText %></p>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>

  <!-- Add Review Modal (your teammateâ€™s file, kept under views/) -->
  <%- include('addReview') %>

  <!-- Login required prompt -->
  <div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginPromptModalLabel">Login Required</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You must be logged in to add a review.
        </div>
        <div class="modal-footer">
          <a href="/login" class="btn btn-primary">Login</a>
          <a href="/signup" class="btn btn-secondary">Sign Up</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle + your modal JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/addReview.js"></script>
</body>
</html>