<!-- 
  File: views/book-details.ejs
  Author: Yusra Ashar
  Description: Displays detailed information about a selected book
               including title, author, description, and cover image.
               Also shows existing user reviews and a button to add a new review.
               Includes conditional rendering for login state and modal triggers.
-->

<%- include('partials/header.ejs') %>

  <!-- Main book detail section -->
  <div class="container mt-4">
    <div class="row">
      <!-- Book cover on the left -->
      <div class="col-md-4">
        <img src="<%= book.imageLinks.thumbnail %>" alt="Book Cover" class="img-fluid shadow">
        <br> <br>
        <h3>Average Rating: <%= book.averageRating %></h3>
      </div>

      <!-- Book info on the right -->
      <div class="col-md-8">
        <h2 id="book-title"><%= book.title %></h2>        
        <h5 class="text-muted">By <%= book.authors %></h5>
        <p><%- book.description ? book.description : "No Description" %></p>

        <!-- Button to add a review (only if logged in) -->
        <% if (logIn) { %>
          <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addReviewModal" id="addNewReview">
            Add Review
          </button>
        <% } else { %>
          <!-- Show login prompt if not logged in -->
          <button class="btn btn-outline-secondary mt-3" data-bs-toggle="modal" data-bs-target="#loginPromptModal">
            Add Review (Login Required)
          </button>
        <% } %>

        <!-- User reviews section -->
        <div class="mt-5">
          <h4>Review Highlights</h4>

          <!-- If no reviews exist yet -->
          <% if (reviews.length === 0) { %>
            <p class="text-muted">No reviews yet. Be the first to leave one!</p>
          <% } else { %>
            <!-- Loop through reviews and display each -->
            <% reviews.forEach(review => { %>
              <div class="card mb-3">
                <div class="card-body">
                  <p><strong><%= review.username %></strong> rated it <%= review.rating %>/5</p>

                  <!-- Show a spoiler badge if applicable -->
                  <% if (review.containsSpoiler) { %>
                    <p class="spoiler-warning">⚠️ Contains Spoilers</p>
                  <% } %>

                  <!-- Review text -->
                  <p class="mt-2"><%= review.reviewText %></p>
                </div>
              </div>
            <% }); %>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for adding a new review (defined in a separate partial) -->
    <form method="POST" action="/api/addReview/<%= bookId %>">
        <%- include('partials/addReview') %>
    </form>
  
  <!-- Modal prompting user to log in -->
  <div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login Required</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You must be logged in to add a review.
        </div>
        <div class="modal-footer">
          <div class="modal-footer">
              <a href="/login?redirectUrl=/books/<%= bookId %>" class="btn btn-primary">Login</a>
              <a href="/signup?redirectUrl=/books/<%= bookId %>" class="btn btn-secondary">Sign Up</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer.ejs') %>
</body>
</html>